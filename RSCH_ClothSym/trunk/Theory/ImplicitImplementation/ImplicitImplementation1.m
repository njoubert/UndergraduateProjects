%
% An implicit integrator and accompanying spring force 
% to simulate a particle system.
%

clear all;
clc;

% We define the parameters of our simulation:
h = 0.01;        %timestep
ks = 20;          %spring constant
kd = 10;         %damping constant
dim = 3;                      %3d simulation

%initial velocities are all zero by default

% We start off by defining our system:
%1 square example:
n = 5;
x = [-1.0 -1.0 0  0.1 -1.0 0  -1.0 0.1 0  0.1 0.1 0  -0.45 -0.45 0.0];
edges = [5 1; 1 2; 5 2; 2 4; 5 4; 4 3; 5 3; 3 1;];
triangles=[5 1 2;5 2 4;5 4 3;5 3 1;];
%4 squares example:
%n = 13;                        %three particle system
%x = [-1.0 -1.0 0.0  0.0 -1.0 0.0  1.0 -1.0 0.0  -1.0 0.0 0.0  0.0 0.0 0.0  1.0 0.0 0.0  -1.0 1.0 0.0  0.0 1.0 0.0  1.0 1.0 0.0  -0.5 -0.5 0.0  0.5 -0.5 0.0  -0.5 0.5 0.0  0.5 0.5 0.0];
%edges = [ 1 2; 10 1; 10 2 ; 10 4 ; 10 5 ; 11 2; 11 3 ; 11 5 ; 11 6 ; 12 4 ; 12 5 ; 12 7 ; 12 8 ; 13 5 ; 13 6 ; 13 8 ; 13 9 ; 2 3; 2 5 ; 3 6 ; 4 1; 4 5; 5 6; 5 8; 6 9; 7 4; 8 7; 9 8;];
%symmetric gid 0.20:
%n = 145;
%x = [-1.0 -1.0 0  -0.75 -1.0 0  -0.5 -1.0 0  -0.25 -1.0 0  0.0 -1.0 0  0.25 -1.0 0  0.5 -1.0 0  0.75 -1.0 0  1.0 -1.0 0  -1.0 -0.75 0  -0.75 -0.75 0  -0.5 -0.75 0  -0.25 -0.75 0  0.0 -0.75 0  0.25 -0.75 0  0.5 -0.75 0  0.75 -0.75 0  1.0 -0.75 0  -1.0 -0.5 0  -0.75 -0.5 0  -0.5 -0.5 0  -0.25 -0.5 0  0.0 -0.5 0  0.25 -0.5 0  0.5 -0.5 0  0.75 -0.5 0  1.0 -0.5 0  -1.0 -0.25 0  -0.75 -0.25 0  -0.5 -0.25 0  -0.25 -0.25 0  0.0 -0.25 0  0.25 -0.25 0  0.5 -0.25 0  0.75 -0.25 0  1.0 -0.25 0  -1.0 0.0 0  -0.75 0.0 0  -0.5 0.0 0  -0.25 0.0 0  0.0 0.0 0  0.25 0.0 0  0.5 0.0 0  0.75 0.0 0  1.0 0.0 0  -1.0 0.25 0  -0.75 0.25 0  -0.5 0.25 0  -0.25 0.25 0  0.0 0.25 0  0.25 0.25 0  0.5 0.25 0  0.75 0.25 0  1.0 0.25 0  -1.0 0.5 0  -0.75 0.5 0  -0.5 0.5 0  -0.25 0.5 0  0.0 0.5 0  0.25 0.5 0  0.5 0.5 0  0.75 0.5 0  1.0 0.5 0  -1.0 0.75 0  -0.75 0.75 0  -0.5 0.75 0  -0.25 0.75 0  0.0 0.75 0  0.25 0.75 0  0.5 0.75 0  0.75 0.75 0  1.0 0.75 0  -1.0 1.0 0  -0.75 1.0 0  -0.5 1.0 0  -0.25 1.0 0  0.0 1.0 0  0.25 1.0 0  0.5 1.0 0  0.75 1.0 0  1.0 1.0 0  -0.875 -0.875 0.0  -0.625 -0.875 0.0  -0.375 -0.875 0.0  -0.125 -0.875 0.0  0.125 -0.875 0.0  0.375 -0.875 0.0  0.625 -0.875 0.0  0.875 -0.875 0.0  -0.875 -0.625 0.0  -0.625 -0.625 0.0  -0.375 -0.625 0.0  -0.125 -0.625 0.0  0.125 -0.625 0.0  0.375 -0.625 0.0  0.625 -0.625 0.0  0.875 -0.625 0.0  -0.875 -0.375 0.0  -0.625 -0.375 0.0  -0.375 -0.375 0.0  -0.125 -0.375 0.0  0.125 -0.375 0.0  0.375 -0.375 0.0  0.625 -0.375 0.0  0.875 -0.375 0.0  -0.875 -0.125 0.0  -0.625 -0.125 0.0  -0.375 -0.125 0.0  -0.125 -0.125 0.0  0.125 -0.125 0.0  0.375 -0.125 0.0  0.625 -0.125 0.0  0.875 -0.125 0.0  -0.875 0.125 0.0  -0.625 0.125 0.0  -0.375 0.125 0.0  -0.125 0.125 0.0  0.125 0.125 0.0  0.375 0.125 0.0  0.625 0.125 0.0  0.875 0.125 0.0  -0.875 0.375 0.0  -0.625 0.375 0.0  -0.375 0.375 0.0  -0.125 0.375 0.0  0.125 0.375 0.0  0.375 0.375 0.0  0.625 0.375 0.0  0.875 0.375 0.0  -0.875 0.625 0.0  -0.625 0.625 0.0  -0.375 0.625 0.0  -0.125 0.625 0.0  0.125 0.625 0.0  0.375 0.625 0.0  0.625 0.625 0.0  0.875 0.625 0.0  -0.875 0.875 0.0  -0.625 0.875 0.0  -0.375 0.875 0.0  -0.125 0.875 0.0  0.125 0.875 0.0  0.375 0.875 0.0  0.625 0.875 0.0  0.875 0.875 0.0];
%edges=[1 2 ;10 1 ;10 11 ;100 21 ;100 22 ;100 30 ;100 31 ;101 22 ;101 23 ;101 31 ;101 32 ;102 23 ;102 24 ;102 32 ;102 33 ;103 24 ;103 25 ;103 33 ;103 34 ;104 25 ;104 26 ;104 34 ;104 35 ;105 26 ;105 27 ;105 35 ;105 36 ;106 28 ;106 29 ;106 37 ;106 38 ;107 29 ;107 30 ;107 38 ;107 39 ;108 30 ;108 31 ;108 39 ;108 40 ;109 31 ;109 32 ;109 40 ;109 41 ;11 12 ;11 2 ;11 20 ;110 32 ;110 33 ;110 41 ;110 42 ;111 33 ;111 34 ;111 42 ;111 43 ;112 34 ;112 35 ;112 43 ;112 44 ;113 35 ;113 36 ;113 44 ;113 45 ;114 37 ;114 38 ;114 46 ;114 47 ;115 38 ;115 39 ;115 47 ;115 48 ;116 39 ;116 40 ;116 48 ;116 49 ;117 40 ;117 41 ;117 49 ;117 50 ;118 41 ;118 42 ;118 50 ;118 51 ;119 42 ;119 43 ;119 51 ;119 52 ;12 13 ;12 21 ;12 3 ;120 43 ;120 44 ;120 52 ;120 53 ;121 44 ;121 45 ;121 53 ;121 54 ;122 46 ;122 47 ;122 55 ;122 56 ;123 47 ;123 48 ;123 56 ;123 57 ;124 48 ;124 49 ;124 57 ;124 58 ;125 49 ;125 50 ;125 58 ;125 59 ;126 50 ;126 51 ;126 59 ;126 60 ;127 51 ;127 52 ;127 60 ;127 61 ;128 52 ;128 53 ;128 61 ;128 62 ;129 53 ;129 54 ;129 62 ;129 63 ;13 14 ;13 22 ;13 4 ;130 55 ;130 56 ;130 64 ;130 65 ;131 56 ;131 57 ;131 65 ;131 66 ;132 57 ;132 58 ;132 66 ;132 67 ;133 58 ;133 59 ;133 67 ;133 68 ;134 59 ;134 60 ;134 68 ;134 69 ;135 60 ;135 61 ;135 69 ;135 70 ;136 61 ;136 62 ;136 70 ;136 71 ;137 62 ;137 63 ;137 71 ;137 72 ;138 64 ;138 65 ;138 73 ;138 74 ;139 65 ;139 66 ;139 74 ;139 75 ;14 15 ;14 23 ;14 5 ;140 66 ;140 67 ;140 75 ;140 76 ;141 67 ;141 68 ;141 76 ;141 77 ;142 68 ;142 69 ;142 77 ;142 78 ;143 69 ;143 70 ;143 78 ;143 79 ;144 70 ;144 71 ;144 79 ;144 80 ;145 71 ;145 72 ;145 80 ;145 81 ;15 16 ;15 24 ;15 6 ;16 17 ;16 25 ;16 7 ;17 18 ;17 26 ;17 8 ;18 27 ;19 10 ;19 20 ;2 3 ;20 21 ;20 29 ;21 22 ;21 30 ;22 23 ;22 31 ;23 24 ;23 32 ;24 25 ;24 33 ;25 26 ;25 34 ;26 27 ;26 35 ;27 36 ;28 19 ;28 29 ;29 30 ;29 38 ;3 4 ;30 31 ;30 39 ;31 32 ;31 40 ;32 33 ;32 41 ;33 34 ;33 42 ;34 35 ;34 43 ;35 36 ;35 44 ;36 45 ;37 28 ;37 38 ;38 39 ;38 47 ;39 40 ;39 48 ;4 5 ;40 41 ;40 49 ;41 42 ;41 50 ;42 43 ;42 51 ;43 44 ;43 52 ;44 45 ;44 53 ;45 54 ;46 37 ;46 47 ;47 48 ;47 56 ;48 49 ;48 57 ;49 50 ;49 58 ;5 6 ;50 51 ;50 59 ;51 52 ;51 60 ;52 53 ;52 61 ;53 54 ;53 62 ;54 63 ;55 46 ;55 56 ;56 57 ;56 65 ;57 58 ;57 66 ;58 59 ;58 67 ;59 60 ;59 68 ;6 7 ;60 61 ;60 69 ;61 62 ;61 70 ;62 63 ;62 71 ;63 72 ;64 55 ;64 65 ;65 66 ;65 74 ;66 67 ;66 75 ;67 68 ;67 76 ;68 69 ;68 77 ;69 70 ;69 78 ;7 8 ;70 71 ;70 79 ;71 72 ;71 80 ;72 81 ;73 64 ;74 73 ;75 74 ;76 75 ;77 76 ;78 77 ;79 78 ;8 9 ;80 79 ;81 80 ;82 1 ;82 10 ;82 11 ;82 2 ;83 11 ;83 12 ;83 2 ;83 3 ;84 12 ;84 13 ;84 3 ;84 4 ;85 13 ;85 14 ;85 4 ;85 5 ;86 14 ;86 15 ;86 5 ;86 6 ;87 15 ;87 16 ;87 6 ;87 7 ;88 16 ;88 17 ;88 7 ;88 8 ;89 17 ;89 18 ;89 8 ;89 9 ;9 18 ;90 10 ;90 11 ;90 19 ;90 20 ;91 11 ;91 12 ;91 20 ;91 21 ;92 12 ;92 13 ;92 21 ;92 22 ;93 13 ;93 14 ;93 22 ;93 23 ;94 14 ;94 15 ;94 23 ;94 24 ;95 15 ;95 16 ;95 24 ;95 25 ;96 16 ;96 17 ;96 25 ;96 26 ;97 17 ;97 18 ;97 26 ;97 27 ;98 19 ;98 20 ;98 28 ;98 29 ;99 20 ;99 21 ;99 29 ;99 30 ;];
rl = zeros(1,length(edges(:,1)));

for i=1:length(edges(:,1)),
  %Get values for edges
    ia = (edges(i,1) - 1)*3 + 1;
    ib = (edges(i,2) - 1)*3 + 1;
    xa = x(ia:ia+2);
    xb = x(ib:ib+2);
    rli = norm(xb-xa);
    rl(i) = rli;   
end

v = zeros(1,n*dim);
M = 1.0*eye(n*dim, n*dim);        %Masses, 10g per particle
%for i=1:3:dim*n,
%    M(i:i+2,i:i+2) = rand()*.01*eye(3,3);      %randomize masses?
%end
Minv = inv(M);

t = 0;
%axis manual;
%axis([-.1 .6 -0.5 .30 -.35 .35]);
figure(1);
clf();
axis([-2 2 -2 2 -2 2]);

for j=1:100,

    %draw:
    hold on;
    for i=1:length(triangles(:,1)),
        paintx = [x((triangles(i,1)-1)*3+1), x((triangles(i,2)-1)*3+1), x((triangles(i,3)-1)*3+1)];
        painty = [x((triangles(i,1)-1)*3+2), x((triangles(i,2)-1)*3+2), x((triangles(i,3)-1)*3+2)];
        paintz = [x((triangles(i,1)-1)*3+3), x((triangles(i,2)-1)*3+3), x((triangles(i,3)-1)*3+3)];
        patch(paintx, painty, paintz, 'r');
    end
    view(3);
    hold off;
    
    %forces:
    f = zeros(1,n*dim);
    JP = zeros(n*dim,n*dim);
    JV = zeros(n*dim,n*dim);
    
    %look at each triangle...
    for i=1:length(edges(:,1)),
        %Get values for edges
       ia = (edges(i,1) - 1)*3 + 1;
       ib = (edges(i,2) - 1)*3 + 1;
       xa = x(ia:ia+2);
       xb = x(ib:ib+2);
       va = v(ia:ia+2);
       vb = v(ib:ib+2);
       
       %Calculate total force on each particle due to this triangle
       fa = fsa(xa,xb,rl(i),ks) + fda(xa,xb,va,vb,kd);
       fb = fsa(xb,xa,rl(i),ks) + fda(xb,xa,vb,va,kd);
       %Accumulate Forces
       f(ia:ia+2) = f(ia:ia+2) + fa;
       f(ib:ib+2) = f(ib:ib+2) + fb;
       
       %Calculate total jacobian wrt position and velocity for each
       %connection.
       JP_fa_xa = jdap(xa,xb,va,vb,rl(i),kd) + jsap(xa, xb, rl(i), ks);
       JP_fb_xa = -1*JP_fa_xa;
       JP_fb_xb = JP_fa_xa;
       JP_fa_xb = -1*JP_fb_xb;
       
       JV_fa_xa = jdav(xa, xb, va, vb, rl(i), kd);
       JV_fb_xa = -1*JV_fa_xa;
       JV_fb_xb = JV_fa_xa;
       JV_fa_xb = -1*JV_fb_xb;
       
       %Accumulate Jacobians
       %remember, JP(force_i, position+i)
       JP(ia:ia+2,ia:ia+2) = JP(ia:ia+2,ia:ia+2) + JP_fa_xa;
       JP(ia:ia+2,ib:ib+2) = JP(ia:ia+2,ib:ib+2) + JP_fa_xb;
       JP(ib:ib+2,ia:ia+2) = JP(ib:ib+2,ia:ia+2) + JP_fb_xa;
       JP(ib:ib+2,ib:ib+2) = JP(ib:ib+2,ib:ib+2) + JP_fb_xb;
       JV(ia:ia+2,ia:ia+2) = JV(ia:ia+2,ia:ia+2) + JV_fa_xa;
       JV(ia:ia+2,ib:ib+2) = JV(ia:ia+2,ib:ib+2) + JV_fa_xb;
       JV(ib:ib+2,ia:ia+2) = JV(ib:ib+2,ia:ia+2) + JV_fb_xa;
       JV(ib:ib+2,ib:ib+2) = JV(ib:ib+2,ib:ib+2) + JV_fb_xb;
    end
    
    %gravity
    for i=1:3:3*n,
       f(i:i+2) = f(i:i+2) + M(i,i)*[0 -9.8 0]; 
    end
    %EXPLICIT FORWARD EULER:
    %delX = h*v;
    %delV = h*f*inv(M);
    
    %JP = zeros(3*n);
    %JV = zeros(3*n);
    
    %IMPLICIT BACKWARDS EULER:
    A = eye(3*n) - h*Minv*JV - h^2*Minv*JP;
    b = h*(f + h*v*JP)*Minv;
    
    %A = M - h*JV - h^2*JP;
    %b = h*(f + (h*JP*v')');
    
    delV = b/A;
    delX = h*(v + delV);
    
    v'
    x'
    f'
    j
    %JP
    %JV
    
    %stupid constraints:
    delX(1:3) = [0 0 0];
    delV(1:3) = [0 0 0];
    
    x = x + delX;
    v = v + delV;
    
end